<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dust Storm Event Analysis - Hetian Basin May 2025</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/plotly.js/2.27.0/plotly.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.21/lodash.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', 'Helvetica Neue', sans-serif;
            background: linear-gradient(135deg, #8B7355 0%, #DEB887 50%, #F4E4C1 100%);
            min-height: 100vh;
            padding: 20px;
            position: relative;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background:
                radial-gradient(circle at 20% 50%, rgba(139, 115, 85, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(222, 184, 135, 0.3) 0%, transparent 50%);
            pointer-events: none;
            z-index: 1;
        }

        .container {
            max-width: 1920px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.98);
            border-radius: 25px;
            box-shadow:
                0 30px 60px rgba(0,0,0,0.4),
                0 0 100px rgba(139, 115, 85, 0.2);
            padding: 40px;
            position: relative;
            z-index: 2;
        }

        h1 {
            text-align: center;
            color: #8B4513;
            font-size: 36px;
            margin-bottom: 10px;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 3px;
            background: linear-gradient(135deg, #8B4513, #D2691E);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .subtitle {
            text-align: center;
            color: #8B7355;
            font-size: 18px;
            margin-bottom: 30px;
            font-weight: 300;
            letter-spacing: 1px;
        }

        .station-info-box {
            background: linear-gradient(145deg, #FFF8DC, #F5DEB3);
            border-left: 5px solid #D2691E;
            padding: 20px;
            margin-bottom: 30px;
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }

        .station-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-top: 15px;
        }

        .station-item {
            background: white;
            padding: 12px;
            border-radius: 8px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
        }

        .station-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.15);
        }

        .station-name {
            font-weight: 600;
            color: #D2691E;
            margin-bottom: 5px;
        }

        .station-type {
            font-size: 12px;
            color: #8B7355;
            display: inline-block;
            padding: 2px 8px;
            background: #F5DEB3;
            border-radius: 12px;
            margin-top: 5px;
        }

        .warning-box {
            background: linear-gradient(145deg, #FFFFE0, #FFE4B5);
            border-left: 6px solid;
            border-image: linear-gradient(180deg, #FF8C00, #FFD700) 1;
            padding: 25px;
            margin-bottom: 35px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(255, 140, 0, 0.15);
        }

        .warning-title {
            font-weight: 700;
            color: #8B4513;
            margin-bottom: 15px;
            font-size: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .warning-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
        }

        .warning-item {
            background: white;
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
        }

        .warning-item.yellow {
            background: linear-gradient(145deg, #FFFACD, #FFD700);
            border-left: 4px solid #FFD700;
        }

        .warning-item.orange {
            background: linear-gradient(145deg, #FFE4B5, #FFA500);
            border-left: 4px solid #FF8C00;
        }

        .chart-container {
            background: linear-gradient(145deg, #ffffff, #f8f9fa);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 35px;
            box-shadow:
                0 10px 40px rgba(0,0,0,0.08),
                inset 0 1px 3px rgba(255,255,255,0.5);
            position: relative;
            transition: all 0.3s ease;
        }

        .chart-container:hover {
            box-shadow:
                0 15px 50px rgba(0,0,0,0.12),
                inset 0 1px 3px rgba(255,255,255,0.5);
        }

        .chart-title {
            font-size: 20px;
            font-weight: 700;
            color: #8B4513;
            margin-bottom: 20px;
            text-align: center;
            position: relative;
            padding-bottom: 10px;
        }

        .chart-title::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100px;
            height: 3px;
            background: linear-gradient(90deg, transparent, #D2691E, transparent);
            border-radius: 2px;
        }

        .grid-2 {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 30px;
        }

        @media (max-width: 1200px) {
            .grid-2 {
                grid-template-columns: 1fr;
            }
            .station-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .status-message {
            padding: 15px 20px;
            border-radius: 12px;
            margin-bottom: 25px;
            display: none;
            font-weight: 500;
            animation: slideIn 0.5s ease;
        }

        @keyframes slideIn {
            from {
                transform: translateY(-20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .status-message.success {
            background: linear-gradient(145deg, #d4edda, #c3e6cb);
            color: #155724;
            border: 1px solid #b1dfbb;
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üå™Ô∏è Dust Storm Event Analysis</h1>
        <div class="subtitle">Hetian, Xinjiang | May 1-7, 2025</div>

        <!-- Station Information -->
        <div class="station-info-box">
            <div class="warning-title">
                <span>üìç</span>
                <span>Meteorological Station Network</span>
            </div>
            <div class="station-grid">
                <div class="station-item">
                    <div class="station-name">Yutian</div>
                    <div>Station: 51931</div>
                    <div>Lon: 81.65¬∞E, Lat: 36.86¬∞N, Alt: 1421.4m</div>
                    <div class="station-type">Urban</div>
                </div>
                <div class="station-item">
                    <div class="station-name">Pishan</div>
                    <div>Station: 51818</div>
                    <div>Lon: 78.28¬∞E, Lat: 37.61¬∞N, Alt: 1372.5m</div>
                    <div class="station-type">Urban</div>
                </div>
                <div class="station-item">
                    <div class="station-name">Cele</div>
                    <div>Station: 51826</div>
                    <div>Lon: 80.81¬∞E, Lat: 37.00¬∞N, Alt: 1331.5m</div>
                    <div class="station-type">Urban</div>
                </div>
                <div class="station-item">
                    <div class="station-name">Luopu</div>
                    <div>Station: 51829</div>
                    <div>Lon: 80.23¬∞E, Lat: 37.05¬∞N, Alt: 1304.2m</div>
                    <div class="station-type">Gobi Desert</div>
                </div>
                <div class="station-item">
                    <div class="station-name">Hetian</div>
                    <div>Station: 51828</div>
                    <div>Lon: 79.92¬∞E, Lat: 37.12¬∞N, Alt: 1374.5m</div>
                    <div class="station-type">Urban</div>
                </div>
                <div class="station-item">
                    <div class="station-name">Minfeng</div>
                    <div>Station: 51839</div>
                    <div>Lon: 82.69¬∞E, Lat: 37.07¬∞N, Alt: 1408.9m</div>
                    <div class="station-type">Urban</div>
                </div>
            </div>
        </div>

        <!-- Warning Information Box -->
        <div class="warning-box">
            <div class="warning-title">
                <span>üö®</span>
                <span>Dust Storm Warning Timeline</span>
            </div>
            <div class="warning-grid">
                <div class="warning-item yellow">
                    <strong>May 2, 2025</strong><br>
                    üü° Dust Storm Yellow Warning<br>
                </div>
                <div class="warning-item orange">
                    <strong>May 3, 2025</strong><br>
                    üü† Dust Storm Orange Warning<br>
                </div>
            </div>
        </div>

        <div id="statusMessage" class="status-message"></div>

        <!-- Chart 1: Multi-Parameter Time Series -->
        <div class="chart-container">
            <div class="chart-title">Figure 1. Comprehensive Meteorological Parameters During Dust Storm Event</div>
            <div id="chart1" style="height: 600px;"></div>
        </div>

        <!-- Chart 2: Visibility-PM10 Relationship -->
        <div class="chart-container">
            <div class="chart-title">Figure 2. Visibility-PM10-PM2.5 Relationship During Dust Storm</div>
            <div id="chart2" style="height: 500px;"></div>
        </div>

        <!-- Chart 3: 3D Phase Space Analysis -->
        <div class="chart-container">
            <div class="chart-title">Figure 3. Three-Dimensional Dust Storm Dynamics</div>
            <div id="chart3" style="height: 550px;"></div>
        </div>

        <!-- Chart 4: Wind Rose Analysis -->
        <div class="chart-container">
            <div class="chart-title">Figure 4. Wind Rose with PM10 Concentration</div>
            <div id="chart4" style="height: 500px;"></div>
        </div>

        <!-- Two column layout -->
        <div class="grid-2">
            <!-- Chart 5: Diurnal Pattern Analysis -->
            <div class="chart-container">
                <div class="chart-title">Figure 5. Diurnal Variation of Dust Storm Parameters</div>
                <div id="chart5" style="height: 400px;"></div>
            </div>

            <!-- Chart 6: Station Comparison -->
            <div class="chart-container">
                <div class="chart-title">Figure 6. Multi-Station PM10 Distribution</div>
                <div id="chart6" style="height: 400px;"></div>
            </div>
        </div>

        <!-- Chart 7: PM10/PM2.5 Ratio Analysis -->
        <div class="chart-container">
            <div class="chart-title">Figure 7. Coarse/Fine Particle Ratio During Dust Storm</div>
            <div id="chart7" style="height: 450px;"></div>
        </div>

        <!-- Chart 8: Temperature-RH-Visibility Correlation -->
        <div class="chart-container">
            <div class="chart-title">Figure 8. Temperature-Humidity-Visibility Correlation Matrix</div>
            <div id="chart8" style="height: 500px;"></div>
        </div>

        <!-- Chart 9: Air Quality Response -->
        <div class="chart-container">
            <div class="chart-title">Figure 9. Air Quality Index Evolution During Dust Storm</div>
            <div id="chart9" style="height: 450px;"></div>
        </div>

        <!-- Chart 10: Vertical Profile Estimation -->
        <div class="chart-container">
            <div class="chart-title">Figure 10. Wind Field and Visibility Distribution Map</div>
            <div id="chart10" style="height: 550px; position: relative;">
                <img id="windFieldImage" src="" style="width: 100%; height: auto; max-height: 500px; object-fit: contain;">
                <div id="imageControls" style="text-align: center; margin-top: 10px;">
                    <input type="range" id="timeSlider" min="0" max="96" value="0" style="width: 80%; margin: 10px;" oninput="updateImage(this.value)">
                    <div id="timeLabel" style="font-weight: bold; margin-top: 5px;">Time: Loading...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let allData = [];

        // Station information
        const stations = {
            '51931': { name: 'Yutian', nameCN: '‰∫éÁî∞', lon: 81.65, lat: 36.86, alt: 1421.4, type: 'Urban' },
            '51818': { name: 'Pishan', nameCN: 'ÁöÆÂ±±', lon: 78.28, lat: 37.61, alt: 1372.5, type: 'Urban' },
            '51826': { name: 'Cele', nameCN: 'Á≠ñÂãí', lon: 80.81, lat: 37.00, alt: 1331.5, type: 'Urban' },
            '51829': { name: 'Luopu', nameCN: 'Ê¥õÊµ¶', lon: 80.23, lat: 37.05, alt: 1304.2, type: 'Gobi' },
            '51828': { name: 'Hetian', nameCN: 'ÂíåÁî∞', lon: 79.92, lat: 37.12, alt: 1374.5, type: 'Urban' },
            '51839': { name: 'Minfeng', nameCN: 'Ê∞ë‰∏∞', lon: 82.69, lat: 37.07, alt: 1408.9, type: 'Urban' }
        };

        // Load and process data
        async function loadData() {
            try {
                showStatus('Loading ht_all.csv...', 'info');
                  const response = await fetch('./ÂíåÁî∞/ht_all.csv');
                  if (!response.ok) {
                      throw new Error(`HTTP error! status: ${response.status}`);
                  }
                  const content = await response.text();
              const parsed = Papa.parse(content, {
                  header: true,
                  dynamicTyping: true,
                  skipEmptyLines: true
              });

                allData = parsed.data.map(row => {
                    const datetime = new Date(row.DATE);
                    const station_id = String(row.station_id);
                    const stationInfo = stations[station_id] || { name: 'Unknown', type: 'Unknown', alt: 1350 };

                    return {
                        datetime: datetime,
                        station: station_id,
                        stationName: stationInfo.name,
                        stationType: stationInfo.type,
                        altitude: stationInfo.alt,
                        temp: row.t,
                        dewpoint: row.dt,
                        pressure: row.p,
                        slp: row.slp,
                        rh: row.rh,
                        visibility: row.vis,
                        ws: row.ws_2min,
                        ws10min: row.ws_10min,
                        wd: row.wd_2min,
                        pm25: row['PM2.5'],
                        pm10: row.PM10,
                        so2: row.SO2,
                        no2: row.NO2,
                        o3: row.O3,
                        co: row.CO,
                        aqi: row.AQI
                    };
                });

                // Sort by datetime
                allData.sort((a, b) => a.datetime - b.datetime);

                createAllCharts();
                showStatus(`Successfully loaded ${allData.length} data points`, 'success');
            } catch (error) {
                console.error('Error loading data:', error);
                createAllCharts();
                showStatus('Using synthetic data for demonstration', 'success');
            }
        }

        // Show status message
        function showStatus(message, type) {
            const statusEl = document.getElementById('statusMessage');
            statusEl.textContent = message;
            statusEl.className = `status-message ${type}`;

            setTimeout(() => {
                statusEl.className = 'status-message';
            }, 5000);
        }

        // Create all charts
        function createAllCharts() {
            createChart1(); // Multi-parameter time series
            createChart2(); // Visibility-PM10 relationship
            createChart3(); // 3D phase space
            createChart4(); // Wind rose
            createChart5(); // Diurnal pattern
            createChart6(); // Station comparison
            createChart7(); // PM10/PM2.5 ratio
            createChart8(); // Correlation matrix
            createChart9(); // AQI evolution
            createChart10(); // Altitude analysis
        }

        // Chart 1: Multi-parameter time series
        function createChart1() {
                const mainStation = allData.filter(d => d.station === '51828');
            if (mainStation.length === 0) return;

            const times = mainStation.map(d => d.datetime);

            // ËÆ°ÁÆóÊâÄÊúâÁ´ôÁÇπÁöÑËåÉÂõ¥ÔºàÂåÖÊã¨51828Ôºâ
            const ranges = {};
            ['pm10', 'pm25', 'visibility', 'ws', 'temp', 'rh'].forEach(param => {
                ranges[param] = times.map(time => {
                    const timeData = allData.filter(d =>
                        d.datetime.getTime() === time.getTime()
                    );
                    if (timeData.length === 0) return { min: null, max: null };
                    const values = timeData.map(d => param === 'visibility' ? d[param]/1000 : d[param]);
                    return {
                        min: Math.min(...values),
                        max: Math.max(...values)
                    };
                });
            });

            const traces = [];

            // Ê∑ªÂä†ËåÉÂõ¥Âå∫Âüü
            // PM10ËåÉÂõ¥
            traces.push({
                x: times,
                y: ranges.pm10.map(r => r.min || 0),
                type: 'scatter',
                mode: 'lines',
                showlegend: false,
                line: { width: 0 },
                yaxis: 'y',
                hoverinfo: 'skip'
            });
            traces.push({
                x: times,
                y: ranges.pm10.map(r => r.max || 0),
                type: 'scatter',
                mode: 'lines',
                fill: 'tonexty',
                fillcolor: 'rgba(139, 69, 19, 0.15)',
                line: { width: 0 },
                yaxis: 'y',
                showlegend: false,
                hoverinfo: 'skip'
            });

            // ËÉΩËßÅÂ∫¶ËåÉÂõ¥
            traces.push({
                x: times,
                y: ranges.visibility.map(r => r.min || 0),
                type: 'scatter',
                mode: 'lines',
                showlegend: false,
                line: { width: 0 },
                yaxis: 'y2',
                hoverinfo: 'skip'
            });
            traces.push({
                x: times,
                y: ranges.visibility.map(r => r.max || 0),
                type: 'scatter',
                mode: 'lines',
                fill: 'tonexty',
                fillcolor: 'rgba(65, 105, 225, 0.15)',
                line: { width: 0 },
                yaxis: 'y2',
                showlegend: false,
                hoverinfo: 'skip'
            });

            // ‰∏ªÁ´ôÊï∞ÊçÆ
            traces.push({
                x: times,
                y: mainStation.map(d => d.pm10),
                type: 'scatter',
                mode: 'lines',
                name: 'PM10 (51828)',
                yaxis: 'y',
                line: { color: '#8B4513', width: 2 }
            });
            traces.push({
                x: times,
                y: mainStation.map(d => d.pm25),
                type: 'scatter',
                mode: 'lines',
                name: 'PM2.5 (51828)',
                yaxis: 'y',
                line: { color: '#D2691E', width: 1.5 }
            });
            traces.push({
                x: times,
                y: mainStation.map(d => d.visibility / 1000),
                type: 'scatter',
                mode: 'lines',
                name: 'Visibility (51828)',
                yaxis: 'y2',
                line: { color: '#4169E1', width: 2 }
            });
            traces.push({
                x: times,
                y: mainStation.map(d => d.ws),
                type: 'scatter',
                mode: 'lines',
                name: 'Wind Speed (51828)',
                yaxis: 'y3',
                line: { color: '#228B22', width: 1.5 }
            });
            traces.push({
                x: times,
                y: mainStation.map(d => d.temp),
                type: 'scatter',
                mode: 'lines',
                name: 'Temperature (51828)',
                yaxis: 'y4',
                line: { color: '#DC143C', width: 1.5 }
            });
            traces.push({
                x: times,
                y: mainStation.map(d => d.rh),
                type: 'scatter',
                mode: 'lines',
                name: 'RH (51828)',
                yaxis: 'y5',
                line: { color: '#9370DB', width: 1.5 }
            });

            const layout = {
                xaxis: {
                    title: 'Datetime',
                    domain: [0.08, 0.84]
                },
                yaxis: {
                    title: 'PM (Œºg/m¬≥)',
                    titlefont: { color: '#8B4513', size: 11 },
                    tickfont: { color: '#8B4513', size: 9 },
                    side: 'left',
                    position: 0
                },
                yaxis2: {
                    title: 'Visibility (km)',
                    titlefont: { color: '#4169E1', size: 11 },
                    tickfont: { color: '#4169E1', size: 9 },
                    overlaying: 'y',
                    side: 'right',
                    anchor: 'free',
                    position: 0.84
                },
                yaxis3: {
                    title: 'Wind (m/s)',
                    titlefont: { color: '#228B22', size: 11 },
                    tickfont: { color: '#228B22', size: 9 },
                    overlaying: 'y',
                    side: 'right',
                    anchor: 'free',
                    position: 0.88
                },
                yaxis4: {
                    title: 'Temp (¬∞C)',
                    titlefont: { color: '#DC143C', size: 11 },
                    tickfont: { color: '#DC143C', size: 9 },
                    overlaying: 'y',
                    side: 'right',
                    anchor: 'free',
                    position: 0.92
                },
                yaxis5: {
                    title: 'RH (%)',
                    titlefont: { color: '#9370DB', size: 11 },
                    tickfont: { color: '#9370DB', size: 9 },
                    overlaying: 'y',
                    side: 'right',
                    anchor: 'free',
                    position: 0.96
                },
                height: 600,
                margin: { l: 80, r: 250, t: 50, b: 80 },
                hovermode: 'x unified',
                shapes: [
                    // {
                    //     type: 'rect',
                    //     xref: 'x',
                    //     yref: 'paper',
                    //     x0: new Date('2025-05-02T00:00:00'),
                    //     x1: new Date('2025-05-02T23:59:59'),
                    //     y0: 0,
                    //     y1: 1,
                    //     fillcolor: 'rgba(255, 215, 0, 0.1)',
                    //     line: { width: 0 }
                    // },
                    {
                        type: 'rect',
                        xref: 'x',
                        yref: 'paper',
                        x0: new Date('2025-05-03T00:00:00'),
                        x1: new Date('2025-05-04T15:59:59'),
                        y0: 0,
                        y1: 1,
                        fillcolor: 'rgba(232,196,152,0.15)',
                        line: { width: 0 }
                    }
                ]
            };

            Plotly.newPlot('chart1', traces, layout, {responsive: true});
        }

        // Chart 2: Visibility-PM10 Relationship
        function createChart2() {
            // ËøáÊª§ÊéâÊó†ÊïàÊï∞ÊçÆÔºàÈÅøÂÖçlog scaleÈóÆÈ¢òÔºâ
            const validData = allData.filter(d =>
                d.visibility > 0 &&
                d.pm10 > 0 &&
                d.pm25 > 0 &&
                d.ws >= 0
            );

            const trace1 = {
                x: validData.map(d => d.visibility / 1000),
                y: validData.map(d => d.pm10),
                mode: 'markers',
                type: 'scatter',
                name: 'PM10',  // ‰øùÊåÅÂêçÁß∞‰∏∫PM10
                marker: {
                    size: 6,
                    color: validData.map(d => d.ws),
                    colorscale: 'Viridis',
                    showscale: true,
                    colorbar: {
                        title: 'Wind Speed<br>(m/s)',
                        x: 1.02,
                        len: 0.8  // Ë∞ÉÊï¥Ëâ≤Êù°ÈïøÂ∫¶ÈÅøÂÖçÈáçÂè†
                    },
                    opacity: 0.6
                },
                text: validData.map(d => `PM10: ${d.pm10}<br>Vis: ${(d.visibility/1000).toFixed(2)}km<br>WS: ${d.ws}m/s`),
                hovertemplate: '%{text}<extra></extra>'
            };

            const trace2 = {
                x: validData.map(d => d.visibility / 1000),
                y: validData.map(d => d.pm25),
                mode: 'markers',
                type: 'scatter',
                name: 'PM2.5',
                marker: {
                    size: 4,
                    color: '#D2691E',
                    opacity: 0.4
                }
            };

            const layout = {
                xaxis: {
                    title: 'Visibility (km)',
                    type: 'log',
                    range: [-1, 2]  // ÈôêÂà∂ËåÉÂõ¥ 0.1-100km
                },
                yaxis: {
                    title: 'Particulate Matter (Œºg/m¬≥)',
                    type: 'log',
                    range: [0, 4]  // ÈôêÂà∂ËåÉÂõ¥ 1-10000 Œºg/m¬≥
                },
                height: 500,
                margin: { l: 80, r: 180, t: 30, b: 60 },
                legend: {
                    x: 0.02,
                    y: 0.98
                }
            };

            Plotly.newPlot('chart2', [trace1, trace2], layout, {responsive: true});
        }

        // Chart 3: 3D Phase Space
        function createChart3() {
            const trace = {
                x: allData.map(d => d.ws),
                y: allData.map(d => d.pm10),
                z: allData.map(d => d.visibility / 1000),
                mode: 'markers',
                marker: {
                    size: 4,
                    color: allData.map(d => d.temp),
                    colorscale: 'Hot',
                    showscale: true,
                    colorbar: {
                        title: 'Temperature<br>(¬∞C)',
                        thickness: 15
                    },
                    opacity: 0.7
                },
                type: 'scatter3d'
            };

            const layout = {
                scene: {
                    xaxis: { title: 'Wind Speed (m/s)' },
                    yaxis: { title: 'PM10 (Œºg/m¬≥)' },
                    zaxis: { title: 'Visibility (km)' },
                    camera: {
                        eye: { x: 1.5, y: -1.5, z: 1.2 }
                    }
                },
                height: 550,
                margin: { l: 0, r: 0, t: 0, b: 0 }
            };

            Plotly.newPlot('chart3', [trace], layout, {responsive: true});
        }

        // Chart 4: Wind Rose
        function createChart4() {
            const windData = allData.filter(d => d.ws > 2 && d.pm10 > 100);
            const sectors = 16;
            const sectorSize = 360 / sectors;
            const roseBins = [];

            for (let i = 0; i < sectors; i++) {
                const sectorStart = i * sectorSize;
                const sectorEnd = (i + 1) * sectorSize;
                const sectorData = windData.filter(d => d.wd >= sectorStart && d.wd < sectorEnd);

                if (sectorData.length > 0) {
                    roseBins.push({
                        direction: sectorStart + sectorSize / 2,
                        avgPM10: _.mean(sectorData.map(d => d.pm10)),
                        avgSpeed: _.mean(sectorData.map(d => d.ws)),
                        count: sectorData.length
                    });
                }
            }

            const trace = {
                r: roseBins.map(b => b.avgPM10),
                theta: roseBins.map(b => b.direction),
                type: 'barpolar',
                marker: {
                    color: roseBins.map(b => b.avgSpeed),
                    colorscale: 'YlOrBr',
                    showscale: true,
                    colorbar: {
                        title: 'Wind Speed<br>(m/s)',
                        x: 1.02
                    }
                }
            };

            const layout = {
                polar: {
                    radialaxis: {
                        visible: true,
                        title: 'Avg PM10 (Œºg/m¬≥)'
                    },
                    angularaxis: {
                        direction: 'clockwise',
                        rotation: 90
                    }
                },
                height: 500
            };

            Plotly.newPlot('chart4', [trace], layout, {responsive: true});
        }

        // Chart 5: Diurnal Pattern
        function createChart5() {
            const hourlyData = {};
            for (let h = 0; h < 24; h++) {
                hourlyData[h] = { pm10: [], pm25: [], vis: [], ws: [] };
            }

            allData.forEach(d => {
                const hour = d.datetime.getHours();
                hourlyData[hour].pm10.push(d.pm10);
                hourlyData[hour].pm25.push(d.pm25);
                hourlyData[hour].vis.push(d.visibility / 1000);
                hourlyData[hour].ws.push(d.ws);
            });

            const hours = Array.from({length: 24}, (_, i) => i);

            const traces = [
                {
                    x: hours,
                    y: hours.map(h => _.mean(hourlyData[h].pm10) || 0),
                    type: 'bar',
                    name: 'PM10',
                    yaxis: 'y',
                    marker: { color: '#8B4513' }
                },
                {
                    x: hours,
                    y: hours.map(h => _.mean(hourlyData[h].vis) || 0),
                    type: 'scatter',
                    mode: 'lines+markers',
                    name: 'Visibility',
                    yaxis: 'y2',
                    line: { color: '#4169E1', width: 2 }
                },
                {
                    x: hours,
                    y: hours.map(h => _.mean(hourlyData[h].ws) || 0),
                    type: 'scatter',
                    mode: 'lines+markers',
                    name: 'Wind Speed',
                    yaxis: 'y3',
                    line: { color: '#228B22', width: 2 }
                }
            ];

            const layout = {
                xaxis: {
                    title: 'Hour of Day',
                    dtick: 3
                },
                yaxis: {
                    title: 'PM10 (Œºg/m¬≥)',
                    titlefont: { color: '#8B4513' },
                    tickfont: { color: '#8B4513' }
                },
                yaxis2: {
                    title: 'Visibility (km)',
                    titlefont: { color: '#4169E1' },
                    tickfont: { color: '#4169E1' },
                    overlaying: 'y',
                    side: 'right'
                },
                yaxis3: {
                    title: 'Wind Speed (m/s)',
                    titlefont: { color: '#228B22' },
                    tickfont: { color: '#228B22' },
                    overlaying: 'y',
                    side: 'right',
                    anchor: 'free',
                    position: 1.1
                },
                height: 400,
                margin: { l: 80, r: 150, t: 30, b: 60 }
            };

            Plotly.newPlot('chart5', traces, layout, {responsive: true});
        }

        // Chart 6: Station Comparison
        function createChart6() {
            const stationGroups = _.groupBy(allData, 'station');
            const traces = [];
            const colors = ['#8B4513', '#D2691E', '#CD853F', '#DEB887', '#F4A460', '#FFE4B5'];

            let colorIdx = 0;
            for (const [station_id, data] of Object.entries(stationGroups)) {
                const stationInfo = stations[station_id] || { name: 'Unknown' };

                traces.push({
                    y: data.map(d => d.pm10),
                    type: 'box',
                    name: stationInfo.nameCN || stationInfo.name,
                    marker: { color: colors[colorIdx % colors.length] },
                    boxmean: 'sd'
                });
                colorIdx++;
            }

            const layout = {
                yaxis: {
                    title: 'PM10 (Œºg/m¬≥)',
                    type: 'log'
                },
                xaxis: { title: 'Station' },
                height: 400
            };

            Plotly.newPlot('chart6', traces, layout, {responsive: true});
        }

        // Chart 7: PM10/PM2.5 Ratio
        function createChart7() {
            const mainStation = allData.filter(d => d.station === '51828');
            const ratioData = mainStation.map(d => ({
                datetime: d.datetime,
                ratio: d.pm10 / d.pm25,
                ws: d.ws,
                visibility: d.visibility / 1000
            })).filter(d => d.ratio > 0 && d.ratio < 20);

            const times = ratioData.map(d => d.datetime);

            const traces = [
                {
                    x: times,
                    y: ratioData.map(d => d.ratio),
                    type: 'scatter',
                    mode: 'lines',
                    name: 'PM10/PM2.5 Ratio',
                    line: { color: '#8B4513', width: 2 },
                    yaxis: 'y'
                },
                {
                    x: times,
                    y: ratioData.map(d => d.ws),
                    type: 'scatter',
                    mode: 'lines',
                    name: 'Wind Speed',
                    line: { color: '#228B22', width: 1.5 },
                    yaxis: 'y2'
                }
            ];

            const layout = {
                xaxis: { title: 'Datetime' },
                yaxis: {
                    title: 'PM10/PM2.5 Ratio',
                    titlefont: { color: '#8B4513' },
                    tickfont: { color: '#8B4513' }
                },
                yaxis2: {
                    title: 'Wind Speed (m/s)',
                    titlefont: { color: '#228B22' },
                    tickfont: { color: '#228B22' },
                    overlaying: 'y',
                    side: 'right'
                },
                height: 450,
                shapes: [
                    {
                        type: 'line',
                        x0: times[0],
                        x1: times[times.length - 1],
                        y0: 2.5,
                        y1: 2.5,
                        line: { color: 'red', width: 2, dash: 'dash' }
                    }
                ],
                annotations: [
                    {
                        x: 0.5,
                        y: 2.5,
                        xref: 'paper',
                        text: 'Typical Urban Ratio',
                        showarrow: false,
                        bgcolor: 'rgba(255,255,255,0.8)'
                    }
                ]
            };

            Plotly.newPlot('chart7', traces, layout, {responsive: true});
        }

        // Chart 8: Correlation Matrix
        function createChart8() {
            const variables = ['Temperature', 'RH', 'Wind Speed', 'Visibility', 'PM10', 'PM2.5'];
            const dataArrays = [
                allData.map(d => d.temp),
                allData.map(d => d.rh),
                allData.map(d => d.ws),
                allData.map(d => d.visibility / 1000),
                allData.map(d => d.pm10),
                allData.map(d => d.pm25)
            ];

            const corrMatrix = [];
            for (let i = 0; i < variables.length; i++) {
                const row = [];
                for (let j = 0; j < variables.length; j++) {
                    const corr = calculateCorrelation(dataArrays[i], dataArrays[j]);
                    row.push(corr);
                }
                corrMatrix.push(row);
            }

            const annotations = [];
            for (let i = 0; i < variables.length; i++) {
                for (let j = 0; j < variables.length; j++) {
                    annotations.push({
                        x: variables[j],
                        y: variables[i],
                        text: corrMatrix[i][j].toFixed(2),
                        showarrow: false,
                        font: {
                            size: 11,
                            color: Math.abs(corrMatrix[i][j]) > 0.5 ? 'white' : 'black'
                        }
                    });
                }
            }

            const trace = {
                z: corrMatrix,
                x: variables,
                y: variables,
                type: 'heatmap',
                colorscale: [[0, '#4169E1'], [0.5, '#ffffff'], [1, '#8B4513']],
                zmin: -1,
                zmax: 1,
                colorbar: { title: 'Correlation' }
            };

            const layout = {
                height: 500,
                annotations: annotations
            };

            Plotly.newPlot('chart8', [trace], layout, {responsive: true});
        }

        // Chart 9: AQI Evolution
        function createChart9() {
            const mainStation = allData.filter(d => d.station === '51828');
            if (mainStation.length === 0) return;

            const times = mainStation.map(d => d.datetime);

            const traces = [
                {
                    x: times,
                    y: mainStation.map(d => d.aqi),
                    type: 'scatter',
                    mode: 'lines',
                    fill: 'tozeroy',
                    name: 'AQI',
                    line: { color: '#8B4513', width: 2 },
                    fillcolor: 'rgba(139, 69, 19, 0.3)'
                }
            ];

            const layout = {
                xaxis: { title: 'Datetime' },
                yaxis: { title: 'Air Quality Index' },
                height: 450,
                shapes: [
                    { type: 'line', x0: times[0], x1: times[times.length-1], y0: 100, y1: 100,
                      line: { color: 'yellow', width: 2, dash: 'dash' } },
                    { type: 'line', x0: times[0], x1: times[times.length-1], y0: 200, y1: 200,
                      line: { color: 'orange', width: 2, dash: 'dash' } },
                    { type: 'line', x0: times[0], x1: times[times.length-1], y0: 300, y1: 300,
                      line: { color: 'red', width: 2, dash: 'dash' } }
                ],
                annotations: [
                    { x: 0.02, y: 100, xref: 'paper', text: 'Moderate', showarrow: false },
                    { x: 0.02, y: 200, xref: 'paper', text: 'Unhealthy', showarrow: false },
                    { x: 0.02, y: 300, xref: 'paper', text: 'Hazardous', showarrow: false }
                ]
            };

            Plotly.newPlot('chart9', traces, layout, {responsive: true});
        }

        // Ê∑ªÂä†ÂÖ®Â±ÄÂèòÈáè
        let animationInterval = null;
        let currentFrame = 0;

        // ÊõøÊç¢createChart10ÂáΩÊï∞
        function createChart10() {
            // ÂàùÂßãÂåñÂõæÂÉèÊòæÁ§∫
            currentFrame = 0;
            updateImage(0);
        }

        // Ê∑ªÂä†Âä®ÁîªÊéßÂà∂ÂáΩÊï∞
        function updateImage(frameIndex) {
            currentFrame = parseInt(frameIndex);
            const paddedIndex = String(currentFrame).padStart(4, '0');
            const imagePath = `./ÂíåÁî∞/wind_field_maps/wind_field_${paddedIndex}.png`;

            document.getElementById('windFieldImage').src = imagePath;
            document.getElementById('timeSlider').value = currentFrame;

            // Êõ¥Êñ∞Êó∂Èó¥Ê†áÁ≠æÔºà5Êúà2-5Êó•Ôºâ
            const startDate = new Date('2025-05-02T00:00:00');
            const currentTime = new Date(startDate.getTime() + currentFrame * 60 * 60 * 1000);
            const timeStr = `${currentTime.getMonth()+1}/${currentTime.getDate()} ${String(currentTime.getHours()).padStart(2,'0')}:00`;
            document.getElementById('timeLabel').textContent = `Time: ${timeStr}`;
        }

        function playAnimation() {
            if (animationInterval) clearInterval(animationInterval);

            animationInterval = setInterval(() => {
                currentFrame++;
                if (currentFrame > 4*24) currentFrame = 0; // 4Â§© * 24Â∞èÊó∂
                updateImage(currentFrame);
            }, 200);
        }

        function pauseAnimation() {
            if (animationInterval) {
                clearInterval(animationInterval);
                animationInterval = null;
            }
        }
        // Helper function
        function calculateCorrelation(x, y) {
            const n = Math.min(x.length, y.length);
            let sumX = 0, sumY = 0, sumXY = 0, sumX2 = 0, sumY2 = 0;

            for (let i = 0; i < n; i++) {
                sumX += x[i];
                sumY += y[i];
                sumXY += x[i] * y[i];
                sumX2 += x[i] * x[i];
                sumY2 += y[i] * y[i];
            }

            const r = (n * sumXY - sumX * sumY) /
                     Math.sqrt((n * sumX2 - sumX * sumX) * (n * sumY2 - sumY * sumY));

            return isNaN(r) ? 0 : r;
        }

        // Initialize
        window.onload = function() {
            loadData();
        };
    </script>
</body>
</html>